# GNU MyServer
#
# Copyright (C) 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010,
# 2011 Free Software Foundation, Inc.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
if BUILD_TESTS
TESTS_DIR = tests
endif

if BUILD_DOC
DOCS = documentation
endif

SUBDIRS = lib po include src $(CONTROL) binaries $(DOCS) $(TESTS_DIR)

include_HEADERS = myserver.h

EXTRA_DIST = doxygen SConstruct .version

ACLOCAL_AMFLAGS = -I m4

BUILT_SOURCES = .version
.version:
	$(AM_V_GEN)echo $(VERSION) > $@-t && mv $@-t $@

# Arrange so that .tarball-version appears only in the distribution
# tarball, and never in a checked-out repository.
dist-hook:
	$(AM_V_GEN)echo $(VERSION) > $(distdir)/.tarball-version

localedir.h: Makefile
	echo '/* This file is auto-generated by Makefile!  */' >$@
	echo '#define LOCALEDIR "$(localedir)"' >> $@

pch: stdafx.h
	$(CXX) -x c++-header stdafx.h -o stdafx.h.gch

all: config.h localedir.h
# Generate the localedir.h file before any other rule.

clean-generic:
	rm -f localedir.h

update-po: check-gettext
	git ls-files src/ | grep "cpp$$" \
		| sort > $(srcdir)/po/POTFILES.in.2 ; \
	if diff $(srcdir)/po/POTFILES.in \
		$(srcdir)/po/POTFILES.in.2 >/dev/null 2>&1 ; then \
		rm -f $(srcdir)/po/POTFILES.in.2 ; \
	else \
		mv $(srcdir)/po/POTFILES.in.2 $(srcdir)/po/POTFILES.in ; \
	fi
	cd po && $(MAKE) $(AM_MAKEFLAGS) update-po

update-gmo: check-gettext
	cd po && $(MAKE) $(AM_MAKEFLAGS) update-gmo

force-update-gmo: check-gettext
	touch po/*.po
	cd po && $(MAKE) $(AM_MAKEFLAGS) update-gmo

force-update-gmo-%: check-gettext
	@language=`echo $@ | sed s/force-update-gmo-//` ; \
	if test ! -f po/$$language.po ; then \
	echo "file po/$$language.po does not exist" ; exit 1 ; fi ; \
	touch po/$$language.po ; \
	cd po && $(MAKE) $(AM_MAKEFLAGS) update-gmo

.PHONY: check-gettext update-po update-gmo force-update-gmo
